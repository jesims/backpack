version: 2

aliases:
  cache:
    lein_cache: &LEIN_CACHE
      key: lein-{{ checksum "project.clj" }}
      paths:
        - ~/.lein
        - ~/.m2
    node_cache: &NODE_CACHE
      key: node-{{ checksum "/tmp/.node_version" }}-{{ checksum "package.json" }}
      paths:
        - node_modules
  containers:
    docker: &DEFAULT
      - image: jesiio/build-bus:latest
        environment:
          JVM_OPTS: -Xmx3200m
          DEBUG: 1
  commands:
    submodule_update: &SUBMODULE_UPDATE
      run:
        name: Git Submodule Update
        command: 'git submodule sync && git submodule update --recursive --init'
    cancel_redundant: &CANCEL_REDUNDANT
      run:
        name: Check & Cancel Redundant Build
        command: 'cancel-redundant-builds.sh'
    notify: &NOTIFY
      run:
        command: './notify.sh'
        when: on_fail

jobs:
  deps:
    docker: *DEFAULT
    steps:
      - *CANCEL_REDUNDANT
      - checkout
      - *SUBMODULE_UPDATE
      - restore_cache:
          <<: *LEIN_CACHE
      - restore_cache:
          <<: *NODE_CACHE
      - run: './backpack.sh deps'
      - *NOTIFY
      - save_cache:
          <<: *LEIN_CACHE
      - save_cache:
          <<: *NODE_CACHE

  test_clj:
    docker: *DEFAULT
    steps:
      - *CANCEL_REDUNDANT
      - checkout
      - *SUBMODULE_UPDATE
      - restore_cache:
          <<: *LEIN_CACHE
      - restore_cache:
          <<: *NODE_CACHE
      - run: './backpack.sh test'
      - *NOTIFY
      - save_cache:
          <<: *LEIN_CACHE
      - save_cache:
          <<: *NODE_CACHE

  test_cljs:
    docker: *DEFAULT
    steps:
      - *CANCEL_REDUNDANT
      - checkout
      - *SUBMODULE_UPDATE
      - restore_cache:
          <<: *LEIN_CACHE
      - restore_cache:
          <<: *NODE_CACHE
      - run: './backpack.sh test-cljs'
      - *NOTIFY
      - save_cache:
          <<: *LEIN_CACHE
      - save_cache:
          <<: *NODE_CACHE

  snapshot:
    docker: *DEFAULT
    steps:
      - *CANCEL_REDUNDANT
      - checkout
      - *SUBMODULE_UPDATE
      - restore_cache:
          <<: *LEIN_CACHE
      - restore_cache:
          <<: *NODE_CACHE
      - run: './backpack.sh snapshot'
      - *NOTIFY
      - save_cache:
          <<: *LEIN_CACHE
      - save_cache:
          <<: *NODE_CACHE

  release:
    docker: *DEFAULT
    steps:
      - *CANCEL_REDUNDANT
      - checkout
      - *SUBMODULE_UPDATE
      - restore_cache:
          <<: *LEIN_CACHE
      - restore_cache:
          <<: *NODE_CACHE
      - run: './backpack.sh release'
      - *NOTIFY
      - save_cache:
          <<: *LEIN_CACHE
      - save_cache:
          <<: *NODE_CACHE

workflows:
  version: 2
  build:
    jobs:
      - deps
      - test_clj:
          requires:
            - deps
      - test_cljs:
          requires:
            - deps
      - snapshot:
          requires:
            - test_clj
            - test_cljs
          filters:
            branches:
              ignore: /^(master|develop)$/
      - release:
          requires:
            - test_clj
            - test_cljs
          filters:
            branches:
              only: master
